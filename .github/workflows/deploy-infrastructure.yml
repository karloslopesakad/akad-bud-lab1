name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'iac/**'
      - '.github/workflows/deploy-infrastructure.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ENVIRONMENT_NAME: lab1

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation template
        run: |
          aws cloudformation validate-template \
            --template-body file://iac/cloudformation/infrastructure.yaml \
            --region ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation Stack
        run: bash scripts/deploy-iac.sh
        env:
          STACK_NAME: akad-bud-lab1-stack
          TEMPLATE_PATH: iac/cloudformation/infrastructure.yaml
          AWS_REGION: ${{ env.AWS_REGION }}
          ENVIRONMENT_NAME: ${{ env.ENVIRONMENT_NAME }}
          CONTAINER_IMAGE: ${{ secrets.ECR_IMAGE_URI }}

      - name: Get Stack Outputs
        run: |
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name akad-bud-lab1-stack \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerDNS`].OutputValue' \
            --output text)
          echo "ALB_DNS=$ALB_DNS" >> $GITHUB_ENV

      - name: Post deployment summary
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CloudFormation stack deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stack Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Stack Name: akad-bud-lab1-stack" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- ALB DNS: ${{ env.ALB_DNS }}" >> $GITHUB_STEP_SUMMARY
